From 6b08033444c0942de3479f4d9434c24e9853b305 Mon Sep 17 00:00:00 2001
From: Allan Sandfeld Jensen <allan.jensen@qt.io>
Date: Tue, 16 Nov 2021 17:06:21 +0100
Subject: [PATCH 076/132] Increment reference count when restoring reference

Otherwise the count will be wrong after an out of memory failure in
reinterpretAsFormat.

Pick-to: 6.2 5.15
Fixes: QTBUG-98377
Change-Id: Ice51d47a6db9277126a5c7337e14aaf5ddee3a10
Reviewed-by: Eirik Aavitsland <eirik.aavitsland@qt.io>
(cherry picked from commit 1a8b7eb1d4f27e74621ee94c01dbeda3afd302c7)
---
 src/gui/image/qimage.cpp | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/gui/image/qimage.cpp b/src/gui/image/qimage.cpp
index a6026d1b88..1389fcfa16 100644
--- a/src/gui/image/qimage.cpp
+++ b/src/gui/image/qimage.cpp
@@ -2254,6 +2254,7 @@ bool QImage::reinterpretAsFormat(Format format)
         // In case detach() ran out of memory
         if (!d) {
             d = oldD;
+            d->ref.ref();
             return false;
         }
     }
-- 
2.35.1

