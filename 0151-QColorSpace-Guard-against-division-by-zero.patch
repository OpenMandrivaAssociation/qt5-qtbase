From a485b1068aee2a2a535f27f0f6fa9823b57940ec Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Robert=20L=C3=B6hning?= <robert.loehning@qt.io>
Date: Thu, 15 Jul 2021 11:52:06 +0200
Subject: [PATCH 151/165] QColorSpace: Guard against division by zero

Fixes oss-fuzz issue 35547.

Pick-to: 5.15 6.2
Change-Id: Ida0b92ab17548f359d8634114bbdeb4c9d3a8dc8
Reviewed-by: Allan Sandfeld Jensen <allan.jensen@qt.io>
(cherry picked from commit 49d89d867c8265674109f7b1b5a2388437a45ed3)
---
 src/gui/painting/qcolorspace.cpp | 14 +++++++++-----
 1 file changed, 9 insertions(+), 5 deletions(-)

diff --git a/src/gui/painting/qcolorspace.cpp b/src/gui/painting/qcolorspace.cpp
index 8b2ea4e04d..5977f8f8c5 100644
--- a/src/gui/painting/qcolorspace.cpp
+++ b/src/gui/painting/qcolorspace.cpp
@@ -146,13 +146,17 @@ QColorMatrix QColorSpacePrimaries::toXyzMatrix() const
         QColorVector srcCone = abrad.map(wXyz);
         QColorVector dstCone = abrad.map(wXyzD50);
 
-        QColorMatrix wToD50 = { { dstCone.x / srcCone.x, 0, 0 },
-                                { 0, dstCone.y / srcCone.y, 0 },
-                                { 0, 0, dstCone.z / srcCone.z } };
+        if (srcCone.x && srcCone.y && srcCone.z) {
+            QColorMatrix wToD50 = { { dstCone.x / srcCone.x, 0, 0 },
+                                    { 0, dstCone.y / srcCone.y, 0 },
+                                    { 0, 0, dstCone.z / srcCone.z } };
 
 
-        QColorMatrix chromaticAdaptation = abradinv * (wToD50 * abrad);
-        toXyz = chromaticAdaptation * toXyz;
+            QColorMatrix chromaticAdaptation = abradinv * (wToD50 * abrad);
+            toXyz = chromaticAdaptation * toXyz;
+        } else {
+            toXyz.r = {0, 0, 0}; // set to invalid value
+        }
     }
 
     return toXyz;
-- 
2.36.1

